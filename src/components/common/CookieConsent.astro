---
import { getLangFromUrl, useTranslations } from '~/i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---

<!-- Bottom Banner -->
<div
  id="cookie-banner"
  class="fixed bottom-0 inset-x-0 z-50 translate-y-full transition-transform duration-300"
  role="region"
  aria-label={t('cookieConsent.settingsTitle')}
>
  <div class="mx-auto max-w-6xl px-4 py-4 sm:px-6">
    <div
      class="flex flex-col gap-3 rounded-xl border border-gray-200 bg-white/90 p-4 shadow-lg backdrop-blur-md dark:border-gray-700 dark:bg-gray-900/90 sm:flex-row sm:items-center sm:gap-4"
    >
      <p class="flex-1 text-sm text-gray-700 dark:text-gray-300">
        {t('cookieConsent.message')}
      </p>
      <div class="flex flex-shrink-0 flex-wrap gap-2">
        <button
          id="cookie-customize"
          class="rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-800"
        >
          {t('cookieConsent.customize')}
        </button>
        <button
          id="cookie-reject"
          class="rounded-lg border border-gray-300 bg-gray-100 px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-200 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700"
        >
          {t('cookieConsent.rejectAll')}
        </button>
        <button
          id="cookie-accept"
          class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white transition hover:bg-blue-700"
        >
          {t('cookieConsent.acceptAll')}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div
  id="cookie-modal"
  class="fixed inset-0 z-[60] flex hidden items-center justify-center bg-black/50 backdrop-blur-sm"
  role="dialog"
  aria-modal="true"
  aria-label={t('cookieConsent.settingsTitle')}
>
  <div
    class="relative mx-4 w-full max-w-md rounded-2xl border border-gray-200 bg-white p-6 shadow-2xl dark:border-gray-700 dark:bg-gray-900"
  >
    <button
      id="cookie-modal-close"
      class="absolute right-4 top-4 text-gray-400 transition hover:text-gray-700 dark:hover:text-gray-200"
      aria-label="Close"
    >
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
        <path
          fill-rule="evenodd"
          d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
          clip-rule="evenodd"></path>
      </svg>
    </button>

    <h2 class="mb-4 text-lg font-semibold text-gray-900 dark:text-white">
      {t('cookieConsent.settingsTitle')}
    </h2>

    <div class="space-y-4">
      <!-- Necessary -->
      <div class="flex items-start justify-between gap-4">
        <div>
          <h3 class="text-sm font-medium text-gray-900 dark:text-white">{t('cookieConsent.necessaryTitle')}</h3>
          <p class="mt-0.5 text-xs text-gray-500 dark:text-gray-400">{t('cookieConsent.necessaryDesc')}</p>
        </div>
        <span class="mt-0.5 flex-shrink-0 text-xs font-medium text-green-600 dark:text-green-400">
          {t('cookieConsent.alwaysOn')}
        </span>
      </div>

      <hr class="border-gray-200 dark:border-gray-700" />

      <!-- Analytics -->
      <div class="flex items-start justify-between gap-4">
        <div>
          <h3 class="text-sm font-medium text-gray-900 dark:text-white">{t('cookieConsent.analyticsTitle')}</h3>
          <p class="mt-0.5 text-xs text-gray-500 dark:text-gray-400">{t('cookieConsent.analyticsDesc')}</p>
        </div>
        <label class="relative mt-0.5 inline-flex flex-shrink-0 cursor-pointer items-center">
          <input type="checkbox" id="cookie-toggle-analytics" class="peer sr-only" />
          <div
            class="h-5 w-9 rounded-full bg-gray-300 after:absolute after:left-[2px] after:top-[2px] after:h-4 after:w-4 after:rounded-full after:bg-white after:transition-transform after:content-[''] peer-checked:bg-blue-600 peer-checked:after:translate-x-full dark:bg-gray-600"
          >
          </div>
        </label>
      </div>

      <hr class="border-gray-200 dark:border-gray-700" />

      <!-- Marketing -->
      <div class="flex items-start justify-between gap-4">
        <div>
          <h3 class="text-sm font-medium text-gray-900 dark:text-white">{t('cookieConsent.marketingTitle')}</h3>
          <p class="mt-0.5 text-xs text-gray-500 dark:text-gray-400">{t('cookieConsent.marketingDesc')}</p>
        </div>
        <label class="relative mt-0.5 inline-flex flex-shrink-0 cursor-pointer items-center">
          <input type="checkbox" id="cookie-toggle-marketing" class="peer sr-only" />
          <div
            class="h-5 w-9 rounded-full bg-gray-300 after:absolute after:left-[2px] after:top-[2px] after:h-4 after:w-4 after:rounded-full after:bg-white after:transition-transform after:content-[''] peer-checked:bg-blue-600 peer-checked:after:translate-x-full dark:bg-gray-600"
          >
          </div>
        </label>
      </div>
    </div>

    <div class="mt-6 flex gap-2">
      <button
        id="cookie-save"
        class="flex-1 rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-800"
      >
        {t('cookieConsent.savePreferences')}
      </button>
      <button
        id="cookie-accept-all-modal"
        class="flex-1 rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white transition hover:bg-blue-700"
      >
        {t('cookieConsent.acceptAll')}
      </button>
    </div>
  </div>
</div>

<script is:inline>
  (function () {
    var STORAGE_KEY = 'cookie-consent';

    function getConsent() {
      try {
        var raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : null;
      } catch (e) {
        return null;
      }
    }

    function setConsent(prefs) {
      prefs.timestamp = Date.now();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(prefs));
      window.dispatchEvent(new CustomEvent('cookie-consent-updated', { detail: prefs }));
    }

    window.getCookieConsent = function () {
      return getConsent();
    };

    function showBanner() {
      var banner = document.getElementById('cookie-banner');
      if (banner) {
        banner.classList.remove('translate-y-full');
        banner.classList.add('translate-y-0');
      }
    }

    function hideBanner() {
      var banner = document.getElementById('cookie-banner');
      if (banner) {
        banner.classList.remove('translate-y-0');
        banner.classList.add('translate-y-full');
      }
    }

    function openModal() {
      var modal = document.getElementById('cookie-modal');
      if (!modal) return;
      modal.classList.remove('hidden');
      var consent = getConsent();
      var analyticsToggle = document.getElementById('cookie-toggle-analytics');
      var marketingToggle = document.getElementById('cookie-toggle-marketing');
      if (analyticsToggle) analyticsToggle.checked = consent ? consent.analytics : false;
      if (marketingToggle) marketingToggle.checked = consent ? consent.marketing : false;
      var closeBtn = document.getElementById('cookie-modal-close');
      if (closeBtn) closeBtn.focus();
    }

    function closeModal() {
      var modal = document.getElementById('cookie-modal');
      if (modal) modal.classList.add('hidden');
    }

    function acceptAll() {
      setConsent({ necessary: true, analytics: true, marketing: true });
      hideBanner();
      closeModal();
    }

    function rejectAll() {
      setConsent({ necessary: true, analytics: false, marketing: false });
      hideBanner();
      closeModal();
    }

    function savePreferences() {
      var analyticsToggle = document.getElementById('cookie-toggle-analytics');
      var marketingToggle = document.getElementById('cookie-toggle-marketing');
      setConsent({
        necessary: true,
        analytics: analyticsToggle ? analyticsToggle.checked : false,
        marketing: marketingToggle ? marketingToggle.checked : false,
      });
      hideBanner();
      closeModal();
    }

    function init() {
      var consent = getConsent();
      if (!consent) {
        showBanner();
      } else {
        hideBanner();
      }

      var acceptBtn = document.getElementById('cookie-accept');
      var rejectBtn = document.getElementById('cookie-reject');
      var customizeBtn = document.getElementById('cookie-customize');
      var saveBtn = document.getElementById('cookie-save');
      var acceptAllModalBtn = document.getElementById('cookie-accept-all-modal');
      var modalCloseBtn = document.getElementById('cookie-modal-close');
      var modal = document.getElementById('cookie-modal');

      if (acceptBtn) acceptBtn.onclick = acceptAll;
      if (rejectBtn) rejectBtn.onclick = rejectAll;
      if (customizeBtn) customizeBtn.onclick = openModal;
      if (saveBtn) saveBtn.onclick = savePreferences;
      if (acceptAllModalBtn) acceptAllModalBtn.onclick = acceptAll;
      if (modalCloseBtn) modalCloseBtn.onclick = closeModal;

      if (modal) {
        modal.addEventListener('click', function (e) {
          if (e.target === modal) closeModal();
        });
      }

      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
          var modal = document.getElementById('cookie-modal');
          if (modal && !modal.classList.contains('hidden')) {
            closeModal();
          }
        }
      });
    }

    init();
    document.addEventListener('astro:after-swap', init);
  })();
</script>
