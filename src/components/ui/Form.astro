---
import type { Form as Props } from '~/types';
import Button from '~/components/ui/Button.astro';

const { inputs, textarea, disclaimer, button = 'Contact us', description = '', apiUrl = '' } = Astro.props;

const lang = Astro.url.pathname.startsWith('/es') ? 'es' : 'en';
---

<form data-api-url={apiUrl || undefined} data-lang={lang}>
  {
    inputs &&
      inputs.map(
        ({ type = 'text', name, label = '', autocomplete = 'on', placeholder = '' }) =>
          name && (
            <div class="mb-6">
              {label && (
                <label for={name} class="block text-sm font-medium">
                  {label}
                </label>
              )}
              <input
                type={type}
                name={name}
                id={name}
                autocomplete={autocomplete}
                placeholder={placeholder}
                class="py-3 px-4 block w-full text-md rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900"
              />
            </div>
          )
      )
  }

  <!-- Honeypot field — hidden from real users, bots auto-fill it -->
  <div class="hidden" aria-hidden="true">
    <input type="text" name="website" tabindex="-1" autocomplete="off" />
  </div>

  {
    textarea && (
      <div>
        <label for="textarea" class="block text-sm font-medium">
          {textarea.label}
        </label>
        <textarea
          id="textarea"
          name={textarea.name ? textarea.name : 'message'}
          rows={textarea.rows ? textarea.rows : 4}
          placeholder={textarea.placeholder}
          class="py-3 px-4 block w-full text-md rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900"
        />
      </div>
    )
  }

  {
    disclaimer && (
      <div class="mt-3 flex items-start">
        <div class="flex mt-0.5">
          <input
            id="disclaimer"
            name="disclaimer"
            type="checkbox"
            class="cursor-pointer mt-1 py-3 px-4 block w-full text-md rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900"
          />
        </div>
        <div class="ml-3">
          <label for="disclaimer" class="cursor-pointer select-none text-sm text-gray-600 dark:text-gray-400">
            {disclaimer.label}
          </label>
        </div>
      </div>
    )
  }

  {
    button && (
      <div class="mt-10 grid">
        <Button variant="primary" type="submit">
          {button}
        </Button>
      </div>
    )
  }

  <div id="form-feedback" class="mt-4 hidden"></div>

  {
    description && (
      <div class="mt-3 text-center">
        <p class="text-sm text-gray-600 dark:text-gray-400">{description}</p>
      </div>
    )
  }
</form>

<script>
  const i18n = {
    en: {
      sending: 'Sending...',
      nameRequired: 'Please enter your name.',
      emailRequired: 'Please enter a valid email address.',
      messageRequired: 'Please enter a message.',
      disclaimerRequired: 'Please accept the privacy disclaimer.',
      success: 'Thank you! Your message has been sent successfully. We will get back to you within 24 business hours.',
      error: 'Something went wrong. Please try again later.',
    },
    es: {
      sending: 'Enviando...',
      nameRequired: 'Por favor, introduce tu nombre.',
      emailRequired: 'Por favor, introduce una dirección de correo electrónico válida.',
      messageRequired: 'Por favor, introduce un mensaje.',
      disclaimerRequired: 'Debes aceptar la política de privacidad.',
      success:
        'Gracias! Tu mensaje ha sido enviado correctamente. Nos pondremos en contacto contigo en un plazo de 24 horas laborables.',
      error: 'Algo salió mal. Por favor, inténtalo de nuevo más tarde.',
    },
  };

  function initContactForm() {
    const forms = document.querySelectorAll<HTMLFormElement>('form[data-api-url]');

    forms.forEach((form) => {
      const apiUrl = form.dataset.apiUrl;
      if (!apiUrl) return;

      // Prevent double-binding after View Transitions
      if (form.dataset.bound === 'true') return;
      form.dataset.bound = 'true';

      // Record page-load timestamp for server-side verification
      const pageLoadedAt = Date.now();

      const lang = (form.dataset.lang || 'en') as 'en' | 'es';
      const t = i18n[lang] || i18n.en;

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const feedback = form.querySelector<HTMLDivElement>('#form-feedback');
        const submitBtn = form.querySelector<HTMLButtonElement>('button[type="submit"]');
        if (!feedback || !submitBtn) return;

        // Reset feedback
        feedback.className = 'mt-4 hidden';
        feedback.textContent = '';

        // Gather values
        const formData = new FormData(form);
        const name = (formData.get('name') as string || '').trim();
        const email = (formData.get('email') as string || '').trim();
        const message = (formData.get('message') as string || '').trim();
        const disclaimerChecked = form.querySelector<HTMLInputElement>('#disclaimer')?.checked ?? false;

        // Client-side validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        if (!name) {
          showFeedback(feedback, t.nameRequired, 'error');
          return;
        }
        if (!email || !emailRegex.test(email)) {
          showFeedback(feedback, t.emailRequired, 'error');
          return;
        }
        if (!message) {
          showFeedback(feedback, t.messageRequired, 'error');
          return;
        }
        if (!disclaimerChecked) {
          showFeedback(feedback, t.disclaimerRequired, 'error');
          return;
        }

        // Read UTM params from URL
        const params = new URLSearchParams(window.location.search);

        const payload = {
          name,
          email,
          practice_name: (formData.get('practice_name') as string || '').trim(),
          inquiry_type: (formData.get('inquiry_type') as string || '').trim(),
          message,
          disclaimer: disclaimerChecked,
          website: (formData.get('website') as string || '').trim(),
          utm_source: params.get('utm_source') || '',
          utm_medium: params.get('utm_medium') || '',
          utm_campaign: params.get('utm_campaign') || '',
          language: lang,
          _t: pageLoadedAt,
        };

        // Loading state
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = t.sending;

        try {
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });

          if (response.ok) {
            // Fire GA4 lead event (respects cookie consent — gtag only exists if analytics accepted)
            if (typeof window.gtag === 'function') {
              window.gtag('event', 'generate_lead', {
                event_category: 'Contact',
                event_label: payload.inquiry_type || 'General',
                language: lang,
                utm_source: payload.utm_source || undefined,
                utm_medium: payload.utm_medium || undefined,
                utm_campaign: payload.utm_campaign || undefined,
              });
            }

            // Replace form content with success message
            form.innerHTML = `
              <div class="text-center py-8">
                <svg class="w-16 h-16 mx-auto text-green-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <p class="text-lg font-medium text-gray-900 dark:text-white">${t.success}</p>
              </div>
            `;
          } else {
            const data = await response.json().catch(() => ({}));
            showFeedback(feedback, data.error || t.error, 'error');
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
          }
        } catch {
          showFeedback(feedback, t.error, 'error');
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      });
    });
  }

  function showFeedback(el: HTMLDivElement, message: string, type: 'error' | 'success') {
    el.className =
      type === 'error'
        ? 'mt-4 p-3 rounded-lg bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-300 text-sm'
        : 'mt-4 p-3 rounded-lg bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-300 text-sm';
    el.textContent = message;
  }

  // Initialize on first load and after View Transitions navigation
  document.addEventListener('astro:page-load', initContactForm);
</script>
