---
import '~/assets/styles/tailwind.css';

import { I18N } from 'astrowind:config';

import CommonMeta from '~/components/common/CommonMeta.astro';
import Favicons from '~/components/Favicons.astro';
import CustomStyles from '~/components/CustomStyles.astro';
import ApplyColorMode from '~/components/common/ApplyColorMode.astro';
import Metadata from '~/components/common/Metadata.astro';
import SiteVerification from '~/components/common/SiteVerification.astro';
import Analytics from '~/components/common/Analytics.astro';
import BasicScripts from '~/components/common/BasicScripts.astro';
import CookieConsent from '~/components/common/CookieConsent.astro';
import JsonLd from '~/components/common/JsonLd.astro';

// Comment the line below to disable View Transitions
import { ClientRouter } from 'astro:transitions';

import type { MetaData as MetaDataType } from '~/types';

export interface Props {
  metadata?: MetaDataType;
}

const { metadata = {} } = Astro.props;
const { textDirection } = I18N;
const lang = Astro.currentLocale || 'en';
---

<!doctype html>
<html lang={lang} dir={textDirection} class="2xl:text-[20px]">
  <head>
    <CommonMeta />
    <Favicons />
    <CustomStyles />
    <ApplyColorMode />
    <Metadata {...metadata} />
    <SiteVerification />
    <Analytics />
    <JsonLd schema={{
      "@context": "https://schema.org",
      "@graph": [
        {
          "@type": "Organization",
          "@id": "https://solutions.futurion.es/#organization",
          "name": "Futurion Solutions",
          "url": "https://solutions.futurion.es",
          "logo": {
            "@type": "ImageObject",
            "url": "https://solutions.futurion.es/favicon.svg"
          },
          "description": "Compliance-first AI automation agency helping small healthcare providers in Spain and the EU automate safely under GDPR. Specialists in dental clinics, pharmacies, and medical practices with 1â€“10 employees.",
          "contactPoint": {
            "@type": "ContactPoint",
            "contactType": "customer service",
            "areaServed": ["ES", "EU"],
            "availableLanguage": ["Spanish", "English"],
            "email": "solutions@futurion.es"
          },
          "sameAs": [
            "https://www.linkedin.com/company/futurion-solutions"
          ]
        },
        {
          "@type": "MedicalBusiness",
          "@id": "https://solutions.futurion.es/#localbusiness",
          "name": "Futurion Solutions",
          "url": "https://solutions.futurion.es",
          "description": "Compliance-first AI automation agency helping small healthcare providers in Spain and the EU automate safely under GDPR.",
          "address": {
            "@type": "PostalAddress",
            "addressLocality": "Valencia",
            "addressCountry": "ES"
          },
          "areaServed": [
            { "@type": "Country", "name": "Spain" },
            { "@type": "Place", "name": "European Union" }
          ],
          "parentOrganization": { "@id": "https://solutions.futurion.es/#organization" }
        },
        {
          "@type": "WebSite",
          "@id": "https://solutions.futurion.es/#website",
          "url": "https://solutions.futurion.es",
          "name": "Futurion Solutions",
          "description": "Compliance-first AI automation for healthcare providers in Spain and the EU",
          "inLanguage": ["en", "es"],
          "publisher": { "@id": "https://solutions.futurion.es/#organization" }
        }
      ]
    }} />

    <!-- Comment the line below to disable View Transitions -->
    <ClientRouter fallback="swap" />
  </head>

  <body class="antialiased text-default bg-page tracking-tight">
    <slot />

    <CookieConsent />
    <BasicScripts />

    <!-- Meta Pixel -->
    <script is:inline>
      (function () {
        var META_PIXEL_ID = '1965358871026784';
        var loaded = false;

        function loadMetaPixel() {
          if (loaded) return;
          try {
            var consent = JSON.parse(localStorage.getItem('cookie-consent') || 'null');
            if (!consent || !consent.marketing) return;
          } catch (e) {
            return;
          }
          loaded = true;
          !function(f,b,e,v,n,t,s)
          {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
          n.callMethod.apply(n,arguments):n.queue.push(arguments)};
          if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
          n.queue=[];t=b.createElement(e);t.async=!0;
          t.src=v;s=b.getElementsByTagName(e)[0];
          s.parentNode.insertBefore(t,s)}(window, document,'script',
          'https://connect.facebook.net/en_US/fbevents.js');
          fbq('init', META_PIXEL_ID);
          fbq('track', 'PageView');
        }

        loadMetaPixel();
        window.addEventListener('cookie-consent-updated', loadMetaPixel);
        document.addEventListener('astro:after-swap', function () {
          if (loaded && window.fbq) {
            fbq('track', 'PageView');
          } else {
            loadMetaPixel();
          }
        });
      })();
    </script>
    <noscript>
      <img height="1" width="1" style="display:none"
        src="https://www.facebook.com/tr?id=1965358871026784&ev=PageView&noscript=1" />
    </noscript>

    <!-- LinkedIn Insight Tag -->
    <script is:inline>
      _linkedin_partner_id = "8651466";
      window._linkedin_data_partner_ids = window._linkedin_data_partner_ids || [];
      window._linkedin_data_partner_ids.push(_linkedin_partner_id);
    </script>
    <script is:inline>
      (function(l) {
        if (!l){window.lintrk = function(a,b){window.lintrk.q.push([a,b])};
        window.lintrk.q=[]}
        var s = document.getElementsByTagName("script")[0];
        var b = document.createElement("script");
        b.type = "text/javascript";b.async = true;
        b.src = "https://snap.licdn.com/li.lms-analytics/insight.min.js";
        s.parentNode.insertBefore(b, s);
      })(window.lintrk);
    </script>
    <noscript>
      <img height="1" width="1" style="display:none;" alt="" src="https://px.ads.linkedin.com/collect/?pid=8651466&fmt=gif" />
    </noscript>
  </body>
</html>
